(function(){"use strict";function v(r,e,t,s,i,n,p,o){var l=typeof r=="function"?r.options:r;return e&&(l.render=e,l.staticRenderFns=t,l._compiled=!0),{exports:r,options:l}}const y={extends:"k-writer-field",props:{ai:[String,Boolean]},data(){return{aiStreaming:!1,aiAbortController:null}},computed:{buttons(){if(!this.ai)return[];if(this.aiStreaming)return[{icon:"loader",text:this.$t("seo.ai.action.stop"),disabled:this.disabled||!this.aiEndpointUrl,theme:"red",click:()=>this.abortAiStream()}];const r=[{icon:this.value===""?"seo-ai":"refresh",text:this.value===""?this.$t("seo.ai.action.generate"):this.$t("seo.ai.action.regenerate"),disabled:this.disabled||!this.aiEndpointUrl,click:()=>this.startAiStream({clearContent:!0})},{icon:"cog",title:this.$t("seo.ai.action.customize"),disabled:this.disabled||!this.aiEndpointUrl,click:()=>this.openCustomizeDialog()}];return this.value!==""?[{icon:"seo-ai",text:this.$t("seo.ai.action.edit"),disabled:this.disabled||!this.aiEndpointUrl,click:()=>this.openEditDialog()},...r]:r},aiEndpointUrl(){var t,s,i;const r=(s=(t=this.$panel)==null?void 0:t.urls)==null?void 0:s.api,e=(i=this.endpoints)==null?void 0:i.field;return!r||!e?null:`${r}/${e}/ai/stream`.replace(/([^:]\/)\/+/g,"$1")}},beforeDestroy(){this.abortAiStream()},methods:{async startAiStream(r={}){var s,i,n,p;const e=this.aiEndpointUrl;if(!e||this.disabled||this.aiStreaming)return;if((s=this.$refs.input)!=null&&s.focus&&this.$refs.input.focus(),r.clearContent){const o=this.getEditor();o&&o.clearContent()}const t=new AbortController;this.aiAbortController=t,this.aiStreaming=!0;try{const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream","X-CSRF":(n=(i=this.$panel)==null?void 0:i.system)==null?void 0:n.csrf,"X-Language":(p=this.$panel)==null?void 0:p.language.code},body:JSON.stringify({instructions:r.instructions,edit:r.edit}),credentials:"same-origin",signal:t.signal});if(!o.ok)try{const l=await o.json();throw new Error((l==null?void 0:l.message)||this.$t("seo.ai.error.request"))}catch{throw new Error(this.$t("seo.ai.error.request"))}if(!o.body)throw new Error(this.$t("seo.ai.error.request"));await this.consumeStream(o.body.getReader())}catch(o){if(o&&o.name==="AbortError")return;console.error(o);const l=o&&o.message?o.message:this.$t("seo.ai.error.request");this.$panel.notification.error(l)}finally{this.aiAbortController=null,this.aiStreaming=!1}},async consumeStream(r){const e=new TextDecoder;let t="";try{for(;;){const{value:s,done:i}=await r.read();if(i)break;s&&(t+=e.decode(s,{stream:!0}),t=this.processStreamBuffer(t))}t+=e.decode(),this.processStreamBuffer(t)}finally{r&&typeof r.releaseLock=="function"&&r.releaseLock()}},processStreamBuffer(r){let e=r;for(;;){const t=e.indexOf(`

`);if(t===-1)return e;const s=e.slice(0,t);if(e=e.slice(t+2),s.trim()==="")continue;const i=s.split(`
`).filter(n=>n.trim().startsWith("data:")).map(n=>n.trim().slice(5)).join(`
`).trim();i!==""&&this.handleAiEvent(i)}},handleAiEvent(r){let e=null;try{e=JSON.parse(r)}catch(t){console.error("Failed to parse AI chunk",t,r);return}if(e.type!=="text-start"){if(e.type==="text-delta"){this.applyAiDelta(e.text||"");return}if(e.type!=="thinking-delta"&&!(e.type==="tool-call"||e.type==="tool-result")&&e.type!=="stream-end"&&e.type==="error")throw new Error(e.payload&&e.payload.message?e.payload.message:this.$t("seo.ai.error.request"))}},applyAiDelta(r){if(!r)return;const e=this.getEditor();if(!e)return;const{state:t,view:s}=e;if(!t||!s)return;const i=t.doc.content.size,n=t.schema.text(r),p=t.tr.insert(i,n);s.dispatch(p)},getEditor(){var e,t;const r=(t=(e=this.$refs.input)==null?void 0:e.$refs)==null?void 0:t.input;return(r==null?void 0:r.editor)||null},abortAiStream(){this.aiAbortController&&(this.aiAbortController.abort(),this.aiAbortController=null),this.aiStreaming=!1},openEditDialog(){this.$panel.dialog.open({component:"k-form-dialog",props:{fields:{instructions:{label:this.$t("seo.ai.dialog.instructions.label"),type:"textarea",buttons:!1,placeholder:this.$t("seo.ai.dialog.instructions.placeholder"),required:!0}},submitButton:this.$t("seo.ai.dialog.edit.submit")},on:{submit:r=>{this.$panel.dialog.close(),this.startAiStream({edit:this.value,instructions:r.instructions})}}})},openCustomizeDialog(){this.$panel.dialog.open({component:"k-form-dialog",props:{fields:{instructions:{label:this.$t("seo.ai.dialog.custom.label"),type:"textarea",buttons:!1,placeholder:this.$t("seo.ai.dialog.custom.placeholder"),required:!0}},submitButton:this.$t("seo.ai.dialog.custom.submit")},on:{submit:r=>{this.$panel.dialog.close(),this.startAiStream({clearContent:!0,instructions:r.instructions})}}})}}};var x=function(){var e=this,t=e._self._c;return t("k-field",e._b({class:["k-writer-field",e.$attrs.class],style:e.$attrs.style,attrs:{counter:e.counterOptions,input:e.id},scopedSlots:e._u([e.disabled?null:{key:"options",fn:function(){return[t("k-button-group",{ref:"buttons",staticClass:"k-field-options",attrs:{buttons:e.buttons,layout:"collapsed",size:"xs",variant:"filled"}})]},proxy:!0}],null,!0)},"k-field",e.$props,!1),[t("k-input",e._b({ref:"input",attrs:{after:e.after,before:e.before,icon:e.icon,type:"seo-writer"},on:{input:function(s){return e.$emit("input",s)}}},"k-input",e.$props,!1))],1)},L=[],T=v(y,x,L);const A=T.exports,R={extends:"k-writer-input",methods:{createNodes(){return Vue.component("k-writer-input").options.methods.createNodes.call(this).filter(e=>e.name!=="hardBreak")}}};var P=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"direction",rawName:"v-direction"}],ref:"editor",class:["k-writer","k-writer-input",e.$attrs.class],style:e.$attrs.style,attrs:{"data-disabled":e.disabled,"data-empty":e.isEmpty,"data-placeholder":e.placeholder,spellcheck:e.spellcheck}},[e.editor&&!e.disabled?t("k-writer-toolbar",e._b({ref:"toolbar",on:{command:e.onCommand}},"k-writer-toolbar",e.toolbarOptions,!1)):e._e(),t("textarea",{ref:"output",staticClass:"input-hidden",attrs:{name:e.name,required:e.required,tabindex:"-1"},domProps:{value:e.value}})],1)},E=[],I=v(R,P,E);const U=I.exports,b=r=>{const e={theme:"blue",...r};return{get button(){var t,s;return{id:e.name,icon:e.icon,label:(s=(t=window.panel)==null?void 0:t.$t)==null?void 0:s.call(t,e.label),name:e.name,inline:!0}},get schema(){return{group:"inline",inline:!0,atom:!0,selectable:!1,attrs:{variable:{default:e.variable}},leafText:t=>`{{ ${t.attrs.variable} }}`,parseDOM:[{tag:`span[data-seo-template-variable="${e.variable}"]`,getAttrs:t=>({variable:t.dataset.seoTemplateVariable??e.variable})}],toDOM:t=>["span",{"data-seo-template-variable":t.attrs.variable},`{{ ${t.attrs.variable} }}`]}},commands({type:t}){return()=>(s,i)=>{if(!i)return!1;const{from:n,to:p}=s.selection,o=t.create({variable:e.variable}),l=s.tr;l.delete(n,p),l.insert(n,o),l.insertText(" ",n+o.nodeSize);const g=s.selection.constructor,c=n+o.nodeSize+1;return l.setSelection(g.near(l.doc.resolve(c))),i(l.scrollIntoView()),!0}},view(t){var i,n;const s=document.createElement("span");return s.className="k-seo-template-variable",s.dataset.theme=e.theme,s.dataset.seoTemplateVariable=t.attrs.variable,s.setAttribute("contenteditable","false"),s.textContent=(n=(i=window.panel)==null?void 0:i.$t)==null?void 0:n.call(i,e.label),{dom:s,update(p){var o,l;return s.dataset.seoTemplateVariable=p.attrs.variable,s.textContent=(l=(o=window.panel)==null?void 0:o.$t)==null?void 0:l.call(o,e.label),!0},ignoreMutation:()=>!0}}}},a=window.Vue;function h(){return window.panel}function V(){return h().api}function D(){return h().app}function w(){const r=V();return{load:({parent:t,name:s})=>r.get(`${t}/sections/${s}`)}}const d=a.computed;a.customRef,a.defineAsyncComponent,a.defineComponent,a.effectScope,a.getCurrentInstance,a.getCurrentScope,a.h,a.inject,a.isProxy,a.isReactive,a.isReadonly,a.isRef,a.isShallow,a.markRaw,a.nextTick,a.onActivated,a.onBeforeMount,a.onBeforeUnmount,a.onBeforeUpdate,a.onDeactivated,a.onErrorCaptured;const k=a.onMounted;a.onRenderTracked,a.onRenderTriggered,a.onScopeDispose,a.onServerPrefetch;const $=a.onUnmounted;a.onUpdated,a.provide,a.proxyRefs,a.reactive,a.readonly;const m=a.ref;a.shallowReactive,a.shallowReadonly,a.shallowRef,a.toRaw,a.toRef,a.toRefs,a.triggerRef,a.unref,a.useAttrs,a.useCssModule,a.useCssVars,a.useListeners,a.useSlots;const H=a.watch;a.watchEffect,a.watchPostEffect,a.watchSyncEffect;const S={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},M={__name:"heading-structure",props:S,setup(r){const e=r,t=h(),{load:s}=w(),i=m(null),n=d(()=>{var c;return(c=i.value)==null?void 0:c.some((_,f)=>{var u;return _.level>(((u=i.value[f-1])==null?void 0:u.level)??0)+1})}),p=d(()=>{var c;return((c=i.value)==null?void 0:c.filter(_=>_.level===1).length)>1}),o=d(()=>{var c;return((c=i.value)==null?void 0:c.filter(_=>_.level===1).length)===0}),l=()=>s({parent:e.parent,name:e.name}).then(c=>{i.value=c.data}),g=(c,_)=>{var f;return!!(c.level>(((f=i.value[_-1])==null?void 0:f.level)??0)+1||c.level===1&&i.value[_-1]||c.level===1&&i.value.filter(u=>u.level===1).length>1)};return k(()=>{l(),t.events.on("content.save",c=>{l()})}),$(()=>t.events.off("content.save")),{__sfc:!0,props:e,panel:t,load:s,data:i,incorrectOrder:n,multipleH1:p,noH1:o,handleLoad:l,itemInvalid:g}}};var N=function(){var e=this,t=e._self._c,s=e._self._setupProxy;return s.data?t("div",{staticClass:"k-section k-heading-structure"},[t("div",{staticClass:"k-field-header k-heading-structure__label k-label k-field-label"},[t("k-icon",{attrs:{type:"headline"}}),t("span",{staticClass:"k-label-text"},[e._v(e._s(s.props.label||e.$t("seo.sections.headingStructure.title")))])],1),t("k-box",{attrs:{theme:"white"}},[t("ol",{staticClass:"k-heading-structure__list"},e._l(s.data,function(i,n){return t("li",{key:n,class:`k-heading-structure__item level-${i.level} ${s.itemInvalid(i,n)?"is-invalid":""}`,style:`z-index: ${s.data.length-n}`},[t("span",{staticClass:"k-heading-structure__item__level"},[e._v(" H"+e._s(i.level)+" ")]),t("span",{staticClass:"k-heading-structure__item__text"},[e._v(e._s(i.text))])])}),0)]),s.incorrectOrder&&!s.noH1?t("k-box",{staticClass:"k-heading-structure__notice",attrs:{theme:"negative"}},[t("k-icon",{attrs:{type:"alert"}}),t("k-text",[e._v(e._s(e.$t("seo.sections.headingStructure.errors.incorrectOrder")))])],1):e._e(),s.multipleH1?t("k-box",{staticClass:"k-heading-structure__notice",attrs:{theme:"negative"}},[t("k-icon",{attrs:{type:"alert"}}),t("k-text",[e._v(e._s(e.$t("seo.sections.headingStructure.errors.multipleH1")))])],1):e._e(),s.noH1?t("k-box",{staticClass:"k-heading-structure__notice",attrs:{theme:"negative"}},[t("k-icon",{attrs:{type:"alert"}}),t("k-text",[e._v(e._s(e.$t("seo.sections.headingStructure.errors.missingH1")))])],1):e._e()],1):e._e()},Z=[],F=v(M,N,Z);const O=F.exports,B={__name:"facebook-preview",props:{ogTitle:String,url:String,ogDescription:String,ogImage:String},setup(r){const e=r,t=d(()=>new window.URL(e.url).host);return{__sfc:!0,props:e,host:t}}};var z=function(){var e=this,t=e._self._c,s=e._self._setupProxy;return t("div",[t("div",{staticClass:"k-facebook-preview"},[e.ogImage?t("div",{staticClass:"k-facebook-preview__image"},[t("img",{staticClass:"k-facebook-preview__img",attrs:{src:e.ogImage}})]):e._e(),t("div",{staticClass:"k-facebook-preview__content"},[t("span",{staticClass:"k-facebook-preview__url"},[e._v(e._s(s.host))]),t("span",{staticClass:"k-facebook-preview__title"},[e._v(e._s(e.ogTitle))]),t("p",{staticClass:"k-facebook-preview__description"},[e._v(e._s(e.ogDescription))])])]),t("a",{staticClass:"k-seo-preview__debugger",attrs:{href:"https://developers.facebook.com/tools/debug/","aria-label":"Facebook Sharing Debugger",target:"_blank",rel:"noopener noreferrer"}},[e._v(" "+e._s(e.$t("seo.sections.preview.openDebugger"))+" "),t("k-icon",{attrs:{type:"open"}})],1)])},q=[],j=v(B,z,q);const G=j.exports,W={__name:"google-preview",props:{title:String,url:String,description:String,ogSiteName:String},setup(r){const e=r,t=d(()=>new window.URL(e.url).origin),s=d(()=>new window.URL(e.url).pathname),i=d(()=>new window.URL(e.url).hostname),n=d(()=>{const p=s.value;if(!p||p==="/")return"";const o=p.split("/").filter(Boolean);return o.length===0?"":o.length===1?` › ${o[0]}`:` › … › ${o[o.length-1]}`});return{__sfc:!0,props:e,origin:t,pathname:s,domain:i,breadcrumbs:n}}};var J=function(){var e=this,t=e._self._c,s=e._self._setupProxy;return t("div",[t("div",{staticClass:"k-google-search-preview"},[t("div",{staticClass:"k-google-search-preview__header"},[t("img",{staticClass:"k-google-search-preview__favicon",attrs:{src:`https://www.google.com/s2/favicons?domain=${s.domain.value}&sz=32`,alt:`${e.ogSiteName} favicon`}}),t("div",{staticClass:"k-google-search-preview__site-info"},[t("span",{staticClass:"k-google-search-preview__site-title"},[e._v(e._s(e.ogSiteName))]),t("span",{staticClass:"k-google-search-preview__url"},[e._v(" "+e._s(s.origin)+e._s(s.breadcrumbs)+" ")])])]),t("h3",{staticClass:"k-google-search-preview__title"},[e._v(e._s(e.title))]),e.description?t("p",{staticClass:"k-google-search-preview__description"},[e._v(" "+e._s(e.description)+" ")]):e._e()]),t("a",{staticClass:"k-seo-preview__debugger",attrs:{href:"https://search.google.com/search-console","aria-label":"Google Search Console",target:"_blank",rel:"noopener noreferrer"}},[e._v(" "+e._s(e.$t("seo.sections.preview.openSearchConsole"))+" "),t("k-icon",{attrs:{type:"open"}})],1)])},X=[],K=v(W,J,X);const Q=K.exports,Y={__name:"slack-preview",props:{ogTitle:String,ogSiteName:String,ogDescription:String,ogImage:String,url:String},setup(r){const e=r,t=d(()=>new window.URL(e.url).origin),s=d(()=>new window.URL(e.url).hostname),i=m(!0);return{__sfc:!0,props:e,origin:t,domain:s,showImage:i}}};var ee=function(){var e=this,t=e._self._c,s=e._self._setupProxy;return t("div",{staticClass:"k-slack-preview"},[t("div",{staticClass:"k-slack-preview__content"},[t("div",{staticClass:"k-slack-preview__site-name"},[t("img",{staticClass:"k-slack-preview__favicon",attrs:{src:`https://www.google.com/s2/favicons?domain=${s.domain}&sz=16`,alt:`${e.ogSiteName} favicon`}}),e._v(" "+e._s(e.ogSiteName||s.origin)+" ")]),t("span",{staticClass:"k-slack-preview__title"},[e._v(e._s(e.ogTitle))]),t("p",{staticClass:"k-slack-preview__description"},[e._v(" "+e._s(e.ogDescription)+" "),e.ogImage?t("button",{staticClass:"k-slack-preview__image-toggle",on:{click:function(i){s.showImage=!s.showImage}}},[e._v(" "+e._s(s.showImage?"▼":"▶")+" ")]):e._e()])]),e.ogImage&&s.showImage?t("div",{staticClass:"k-slack-preview__image"},[t("img",{attrs:{src:e.ogImage}})]):e._e()])},te=[],se=v(Y,ee,te);const re=se.exports,ae={__name:"seo-preview",props:S,setup(r){const e=r,t=h(),s=D(),{load:i}=w(),n=m(null),p=m([]),o=d(()=>e.parent==="site"),l=d(()=>{var u;return e.label||((u=t==null?void 0:t.t)==null?void 0:u.call(t,"seo.sections.preview.title"))||"Preview"}),g=d(()=>{var C;const u=(C=n.value)==null?void 0:C.pageTitle;if(o.value&&u){const ce=u.replaceAll('"','\\"');return`${l.value} (shows "${ce}")`}return l.value}),c=m(window.localStorage.getItem("kSEOPreviewType")??"google");H(c,u=>{window.localStorage.setItem("kSEOPreviewType",u)});const _=()=>{i({parent:e.parent,name:e.name}).then(u=>{n.value=u.meta,p.value=u.options,!window.localStorage.getItem("kSEOPreviewType")&&u.options.length>0&&(c.value=u.options[0].value)})},f=()=>{var u;(u=n.value)!=null&&u.panelUrl&&s.$go(n.value.panelUrl)};return k(()=>{_(),t.events.on("content.save",u=>{_()})}),$(()=>t.events.off("content.save")),{__sfc:!0,props:e,panel:t,app:s,load:i,meta:n,options:p,isSiteParent:o,baseLabel:l,headerLabel:g,type:c,handleLoad:_,openPanelTarget:f,FacebookPreview:G,GooglePreview:Q,SlackPreview:re}}};var ie=function(){var i;var e=this,t=e._self._c,s=e._self._setupProxy;return t("div",{staticClass:"k-section k-seo-preview"},[t("div",{staticClass:"k-field-header k-seo-preview__label k-label k-field-label"},[t("k-icon",{attrs:{type:"preview"}}),t("span",{staticClass:"k-label-text"},[e._v(" "+e._s(s.headerLabel)+" ")]),s.isSiteParent&&((i=s.meta)!=null&&i.panelUrl)?t("k-button",{staticClass:"k-seo-preview__panel-button",attrs:{variant:"filled",size:"xs",icon:"edit"},on:{click:s.openPanelTarget}},[e._v(" View page in panel ")]):e._e()],1),t("k-select-field",{attrs:{type:"select",name:"seo-preview-type",before:e.$t("seo.sections.preview.showFor"),options:s.options,required:!0,empty:!1},model:{value:s.type,callback:function(n){s.type=n},expression:"type"}}),s.meta?t("div",{staticClass:"k-seo-preview__inner"},[s.type==="google"?t(s.GooglePreview,e._b({},"google-preview",s.meta,!1)):e._e(),s.type==="facebook"?t(s.FacebookPreview,e._b({},"facebook-preview",s.meta,!1)):e._e(),s.type==="slack"?t(s.SlackPreview,e._b({},"slack-preview",s.meta,!1)):e._e()],1):e._e()],1)},oe=[],ne=v(ae,ie,oe);const le=ne.exports;panel.plugin("tobimori/seo",{icons:{"seo-ai":'<path d="M16.4356 3.21188C16.8261 2.82185 17.4592 2.82157 17.8496 3.21188L20.6777 6.04099C21.0681 6.43152 21.0682 7.06457 20.6777 7.45505L7.2422 20.8896H3.00001V16.6475L16.4356 3.21188ZM5.00001 17.4756V18.8896H6.41407L15.7276 9.57615L14.3135 8.16208L5.00001 17.4756ZM4.5293 1.3193C4.70583 0.893505 5.29418 0.893508 5.47071 1.3193L5.72364 1.93063C6.15555 2.97342 6.96155 3.80613 7.97462 4.2568L8.69239 4.57614C9.10267 4.75896 9.10262 5.35616 8.69239 5.53903L7.93263 5.87692C6.94497 6.3162 6.15339 7.11943 5.71387 8.1279L5.4668 8.69334C5.28636 9.10747 4.71366 9.10747 4.53321 8.69334L4.28614 8.1279C3.84661 7.11943 3.05506 6.3162 2.06739 5.87692L1.30762 5.53903C0.897483 5.35617 0.897435 4.75896 1.30762 4.57614L2.0254 4.2568C3.03845 3.80614 3.84446 2.97344 4.27637 1.93063L4.5293 1.3193ZM15.7276 6.74802L17.1426 8.16208L18.5567 6.74802L17.1426 5.33395L15.7276 6.74802Z" />',robots:'<path d="M13.5 2c0 .444-.193.843-.5 1.118V5h5a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3h5V3.118A1.5 1.5 0 1 1 13.5 2ZM6 7a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H6Zm-4 3H0v6h2v-6Zm20 0h2v6h-2v-6ZM9 14.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm6 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />',"robots-off":'<path fill-rule="evenodd" clip-rule="evenodd" d="M21 16.786V8a3 3 0 0 0-3-3h-5V3.118a1.5 1.5 0 1 0-2 0V5H9.214l2 2H18a1 1 0 0 1 1 1v6.786l2 2ZM2.093 3.507l2.099 2.099A2.995 2.995 0 0 0 3 8v10a3 3 0 0 0 3 3h12c.463 0 .902-.105 1.293-.292l1.9 1.9 1.414-1.415-6.88-6.88a1.5 1.5 0 1 0-2.04-2.04L3.508 2.093 2.093 3.507ZM5 8a1 1 0 0 1 .65-.937L17.585 19H6a1 1 0 0 1-1-1V8Zm-5 2h2v6H0v-6Zm24 0h-2v6h2v-6Zm-13.5 3a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />'},sections:{"heading-structure":O,"seo-preview":le},fields:{"seo-writer":A},components:{"k-seo-writer-input":U},writerNodes:{seoTemplateTitle:b({name:"seoTemplateTitle",icon:"page",variable:"title",label:"seo.writerNodes.template.title",theme:"blue"}),seoTemplateSiteTitle:b({name:"seoTemplateSiteTitle",icon:"globe",variable:"site.title",label:"seo.writerNodes.template.siteTitle",theme:"purple"})}})})();
