(function(){"use strict";function f(s,e,t,r,i,n,u,o){var l=typeof s=="function"?s.options:s;return e&&(l.render=e,l.staticRenderFns=t,l._compiled=!0),{exports:s,options:l}}const C={extends:"k-writer-field",props:{ai:[String,Boolean]},data(){return{aiStreaming:!1,aiAbortController:null,aiError:null}},computed:{buttons(){return this.aiTask?[{icon:this.aiStreaming?"loader":"seo-ai",text:this.aiStreaming?this.$t("seo.ai.action.stop"):this.$t("seo.ai.action.generate"),disabled:this.disabled||!this.aiEndpointUrl,theme:this.aiStreaming?"red":null,click:()=>this.toggleAiStream()},{icon:"cog",title:this.$t("seo.ai.action.generate"),disabled:this.disabled||!this.aiEndpointUrl,click:()=>{}}]:[]},aiTask(){if(!this.ai||typeof this.ai!="string")return null;const s=this.ai.trim();return s===""||s==="false"?null:s},aiEndpointUrl(){var t,r,i;const s=(r=(t=this.$panel)==null?void 0:t.urls)==null?void 0:r.api,e=(i=this.endpoints)==null?void 0:i.field;return!s||!e?null:`${s}/${e}/ai/stream`.replace(/([^:]\/)\/+/g,"$1")}},beforeDestroy(){this.abortAiStream()},methods:{toggleAiStream(){if(this.aiStreaming){this.abortAiStream();return}this.startAiStream()},async startAiStream(){const s=this.aiTask,e=this.aiEndpointUrl;if(!s||!e||this.disabled||this.aiStreaming)return;this.aiError=null,this.focusWriter();const t=new AbortController;this.aiAbortController=t,this.aiStreaming=!0;try{const r=await fetch(e,this.aiRequestOptions(t.signal,s));if(!r.ok)throw new Error(await this.extractErrorMessage(r));if(!r.body)throw new Error(this.$t("seo.ai.error.request"));await this.consumeStream(r.body.getReader())}catch(r){if(r&&r.name==="AbortError")return;console.error(r),this.handleAiError(r)}finally{this.cleanupAiStream()}},async consumeStream(s){const e=new TextDecoder;let t="";try{for(;;){const{value:r,done:i}=await s.read();if(i)break;r&&(t+=e.decode(r,{stream:!0}),t=this.processStreamBuffer(t))}t+=e.decode(),this.processStreamBuffer(t)}finally{s&&typeof s.releaseLock=="function"&&s.releaseLock()}},processStreamBuffer(s){let e=s;for(;;){const t=e.indexOf(`

`);if(t===-1)return e;const r=e.slice(0,t);if(e=e.slice(t+2),r.trim()==="")continue;const i=r.split(`
`).filter(n=>n.trim().startsWith("data:")).map(n=>n.trim().slice(5)).join(`
`).trim();i!==""&&this.handleAiEvent(i)}},handleAiEvent(s){let e=null;try{e=JSON.parse(s)}catch(t){console.error("Failed to parse AI chunk",t,s);return}if(e.type==="text-start"){this.aiError=null;return}if(e.type==="text-delta"){this.applyAiDelta(e.text||"");return}if(e.type!=="thinking-delta"&&!(e.type==="tool-call"||e.type==="tool-result")&&e.type!=="stream-end"&&e.type==="error")throw new Error(e.payload&&e.payload.message?e.payload.message:this.$t("seo.ai.error.request"))},applyAiDelta(s){if(!s)return;const e=this.$refs.input&&this.$refs.input.$refs&&this.$refs.input.$refs.input;e&&typeof e.insertAiText=="function"&&e.insertAiText(s)},aiRequestOptions(s){var e;return{method:"POST",headers:this.aiHeaders(),body:JSON.stringify({lang:(e=this.$panel)==null?void 0:e.language.code}),credentials:"same-origin",signal:s}},aiHeaders(){var r,i,n,u,o;const s={"Content-Type":"application/json",Accept:"text/event-stream"},e=((i=(r=this.$panel)==null?void 0:r.system)==null?void 0:i.csrf)||((n=this.$config)==null?void 0:n.csrf),t=((u=this.$panel)==null?void 0:u.language)||((o=this.$config)==null?void 0:o.language);return e&&(s["X-CSRF"]=e),t&&(s["X-Language"]=t),s},focusWriter(){this.$refs.input&&typeof this.$refs.input.focus=="function"&&this.$refs.input.focus()},abortAiStream(){this.aiAbortController&&(this.aiAbortController.abort(),this.aiAbortController=null),this.aiStreaming=!1},cleanupAiStream(){this.aiAbortController=null,this.aiStreaming=!1},async extractErrorMessage(s){try{const e=await s.json();if(e&&typeof e.message=="string")return e.message}catch{}return this.$t("seo.ai.error.request")},handleAiError(s){const e=s&&s.message?s.message:this.$t("seo.ai.error.request");if(this.aiError=e,this.$panel&&this.$panel.notification&&typeof this.$panel.notification.error=="function"){this.$panel.notification.error(e);return}console.error(e)}}};var x=function(){var e=this,t=e._self._c;return t("k-field",e._b({class:["k-writer-field",e.$attrs.class],style:e.$attrs.style,attrs:{counter:e.counterOptions,input:e.id},scopedSlots:e._u([e.disabled?null:{key:"options",fn:function(){return[t("k-button-group",{ref:"buttons",staticClass:"k-field-options",attrs:{buttons:e.buttons,layout:"collapsed",size:"xs",variant:"filled"}})]},proxy:!0}],null,!0)},"k-field",e.$props,!1),[t("k-input",e._b({ref:"input",attrs:{after:e.after,before:e.before,icon:e.icon,type:"seo-writer"},on:{input:function(r){return e.$emit("input",r)}}},"k-input",e.$props,!1))],1)},T=[],A=f(C,x,T);const L=A.exports,R={extends:"k-writer-input",methods:{createNodes(){return Vue.component("k-writer-input").options.methods.createNodes.call(this).filter(e=>e.name!=="hardBreak")},async insertAiText(s){if(!s)return;const e=this.editor;if(!e)return;const t=String(s);await this.$nextTick();const{state:r,view:i}=e;if(!r||!i)return;const{selection:n,tr:u}=r,o=r.schema.text(t),l=u.insert(n.from,o);i.dispatch(l),e.focus()}}};var P=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"direction",rawName:"v-direction"}],ref:"editor",class:["k-writer","k-writer-input",e.$attrs.class],style:e.$attrs.style,attrs:{"data-disabled":e.disabled,"data-empty":e.isEmpty,"data-placeholder":e.placeholder,spellcheck:e.spellcheck}},[e.editor&&!e.disabled?t("k-writer-toolbar",e._b({ref:"toolbar",on:{command:e.onCommand}},"k-writer-toolbar",e.toolbarOptions,!1)):e._e(),t("textarea",{ref:"output",staticClass:"input-hidden",attrs:{name:e.name,required:e.required,tabindex:"-1"},domProps:{value:e.value}})],1)},E=[],I=f(R,P,E);const H=I.exports,w=s=>{const e={theme:"blue",...s};return{get button(){var t,r;return{id:e.name,icon:e.icon,label:(r=(t=window.panel)==null?void 0:t.$t)==null?void 0:r.call(t,e.label),name:e.name,inline:!0}},get schema(){return{group:"inline",inline:!0,atom:!0,selectable:!1,attrs:{variable:{default:e.variable}},leafText:t=>`{{ ${t.attrs.variable} }}`,parseDOM:[{tag:`span[data-seo-template-variable="${e.variable}"]`,getAttrs:t=>({variable:t.dataset.seoTemplateVariable??e.variable})}],toDOM:t=>["span",{"data-seo-template-variable":t.attrs.variable},`{{ ${t.attrs.variable} }}`]}},commands({type:t}){return()=>(r,i)=>{if(!i)return!1;const{from:n,to:u}=r.selection,o=t.create({variable:e.variable}),l=r.tr;l.delete(n,u),l.insert(n,o),l.insertText(" ",n+o.nodeSize);const g=r.selection.constructor,c=n+o.nodeSize+1;return l.setSelection(g.near(l.doc.resolve(c))),i(l.scrollIntoView()),!0}},view(t){var i,n;const r=document.createElement("span");return r.className="k-seo-template-variable",r.dataset.theme=e.theme,r.dataset.seoTemplateVariable=t.attrs.variable,r.setAttribute("contenteditable","false"),r.textContent=(n=(i=window.panel)==null?void 0:i.$t)==null?void 0:n.call(i,e.label),{dom:r,update(u){var o,l;return r.dataset.seoTemplateVariable=u.attrs.variable,r.textContent=(l=(o=window.panel)==null?void 0:o.$t)==null?void 0:l.call(o,e.label),!0},ignoreMutation:()=>!0}}}},a=window.Vue;function h(){return window.panel}function M(){return h().api}function V(){return h().app}function k(){const s=M();return{load:({parent:t,name:r})=>s.get(`${t}/sections/${r}`)}}const d=a.computed;a.customRef,a.defineAsyncComponent,a.defineComponent,a.effectScope,a.getCurrentInstance,a.getCurrentScope,a.h,a.inject,a.isProxy,a.isReactive,a.isReadonly,a.isRef,a.isShallow,a.markRaw,a.nextTick,a.onActivated,a.onBeforeMount,a.onBeforeUnmount,a.onBeforeUpdate,a.onDeactivated,a.onErrorCaptured;const b=a.onMounted;a.onRenderTracked,a.onRenderTriggered,a.onScopeDispose,a.onServerPrefetch;const S=a.onUnmounted;a.onUpdated,a.provide,a.proxyRefs,a.reactive,a.readonly;const m=a.ref;a.shallowReactive,a.shallowReadonly,a.shallowRef,a.toRaw,a.toRef,a.toRefs,a.triggerRef,a.unref,a.useAttrs,a.useCssModule,a.useCssVars,a.useListeners,a.useSlots;const N=a.watch;a.watchEffect,a.watchPostEffect,a.watchSyncEffect;const $={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},U={__name:"heading-structure",props:$,setup(s){const e=s,t=h(),{load:r}=k(),i=m(null),n=d(()=>{var c;return(c=i.value)==null?void 0:c.some((_,v)=>{var p;return _.level>(((p=i.value[v-1])==null?void 0:p.level)??0)+1})}),u=d(()=>{var c;return((c=i.value)==null?void 0:c.filter(_=>_.level===1).length)>1}),o=d(()=>{var c;return((c=i.value)==null?void 0:c.filter(_=>_.level===1).length)===0}),l=()=>r({parent:e.parent,name:e.name}).then(c=>{i.value=c.data}),g=(c,_)=>{var v;return!!(c.level>(((v=i.value[_-1])==null?void 0:v.level)??0)+1||c.level===1&&i.value[_-1]||c.level===1&&i.value.filter(p=>p.level===1).length>1)};return b(()=>{l(),t.events.on("content.save",c=>{l()})}),S(()=>t.events.off("content.save")),{__sfc:!0,props:e,panel:t,load:r,data:i,incorrectOrder:n,multipleH1:u,noH1:o,handleLoad:l,itemInvalid:g}}};var O=function(){var e=this,t=e._self._c,r=e._self._setupProxy;return r.data?t("div",{staticClass:"k-section k-heading-structure"},[t("div",{staticClass:"k-field-header k-heading-structure__label k-label k-field-label"},[t("k-icon",{attrs:{type:"headline"}}),t("span",{staticClass:"k-label-text"},[e._v(e._s(r.props.label||e.$t("seo.sections.headingStructure.title")))])],1),t("k-box",{attrs:{theme:"white"}},[t("ol",{staticClass:"k-heading-structure__list"},e._l(r.data,function(i,n){return t("li",{key:n,class:`k-heading-structure__item level-${i.level} ${r.itemInvalid(i,n)?"is-invalid":""}`,style:`z-index: ${r.data.length-n}`},[t("span",{staticClass:"k-heading-structure__item__level"},[e._v(" H"+e._s(i.level)+" ")]),t("span",{staticClass:"k-heading-structure__item__text"},[e._v(e._s(i.text))])])}),0)]),r.incorrectOrder&&!r.noH1?t("k-box",{staticClass:"k-heading-structure__notice",attrs:{theme:"negative"}},[t("k-icon",{attrs:{type:"alert"}}),t("k-text",[e._v(e._s(e.$t("seo.sections.headingStructure.errors.incorrectOrder")))])],1):e._e(),r.multipleH1?t("k-box",{staticClass:"k-heading-structure__notice",attrs:{theme:"negative"}},[t("k-icon",{attrs:{type:"alert"}}),t("k-text",[e._v(e._s(e.$t("seo.sections.headingStructure.errors.multipleH1")))])],1):e._e(),r.noH1?t("k-box",{staticClass:"k-heading-structure__notice",attrs:{theme:"negative"}},[t("k-icon",{attrs:{type:"alert"}}),t("k-text",[e._v(e._s(e.$t("seo.sections.headingStructure.errors.missingH1")))])],1):e._e()],1):e._e()},Z=[],F=f(U,O,Z);const D=F.exports,B={__name:"facebook-preview",props:{ogTitle:String,url:String,ogDescription:String,ogImage:String},setup(s){const e=s,t=d(()=>new window.URL(e.url).host);return{__sfc:!0,props:e,host:t}}};var q=function(){var e=this,t=e._self._c,r=e._self._setupProxy;return t("div",[t("div",{staticClass:"k-facebook-preview"},[e.ogImage?t("div",{staticClass:"k-facebook-preview__image"},[t("img",{staticClass:"k-facebook-preview__img",attrs:{src:e.ogImage}})]):e._e(),t("div",{staticClass:"k-facebook-preview__content"},[t("span",{staticClass:"k-facebook-preview__url"},[e._v(e._s(r.host))]),t("span",{staticClass:"k-facebook-preview__title"},[e._v(e._s(e.ogTitle))]),t("p",{staticClass:"k-facebook-preview__description"},[e._v(e._s(e.ogDescription))])])]),t("a",{staticClass:"k-seo-preview__debugger",attrs:{href:"https://developers.facebook.com/tools/debug/","aria-label":"Facebook Sharing Debugger",target:"_blank",rel:"noopener noreferrer"}},[e._v(" "+e._s(e.$t("seo.sections.preview.openDebugger"))+" "),t("k-icon",{attrs:{type:"open"}})],1)])},z=[],j=f(B,q,z);const W=j.exports,G={__name:"google-preview",props:{title:String,url:String,description:String,ogSiteName:String},setup(s){const e=s,t=d(()=>new window.URL(e.url).origin),r=d(()=>new window.URL(e.url).pathname),i=d(()=>new window.URL(e.url).hostname),n=d(()=>{const u=r.value;if(!u||u==="/")return"";const o=u.split("/").filter(Boolean);return o.length===0?"":o.length===1?` › ${o[0]}`:` › … › ${o[o.length-1]}`});return{__sfc:!0,props:e,origin:t,pathname:r,domain:i,breadcrumbs:n}}};var J=function(){var e=this,t=e._self._c,r=e._self._setupProxy;return t("div",[t("div",{staticClass:"k-google-search-preview"},[t("div",{staticClass:"k-google-search-preview__header"},[t("img",{staticClass:"k-google-search-preview__favicon",attrs:{src:`https://www.google.com/s2/favicons?domain=${r.domain.value}&sz=32`,alt:`${e.ogSiteName} favicon`}}),t("div",{staticClass:"k-google-search-preview__site-info"},[t("span",{staticClass:"k-google-search-preview__site-title"},[e._v(e._s(e.ogSiteName))]),t("span",{staticClass:"k-google-search-preview__url"},[e._v(" "+e._s(r.origin)+e._s(r.breadcrumbs)+" ")])])]),t("h3",{staticClass:"k-google-search-preview__title"},[e._v(e._s(e.title))]),e.description?t("p",{staticClass:"k-google-search-preview__description"},[e._v(" "+e._s(e.description)+" ")]):e._e()]),t("a",{staticClass:"k-seo-preview__debugger",attrs:{href:"https://search.google.com/search-console","aria-label":"Google Search Console",target:"_blank",rel:"noopener noreferrer"}},[e._v(" "+e._s(e.$t("seo.sections.preview.openSearchConsole"))+" "),t("k-icon",{attrs:{type:"open"}})],1)])},X=[],K=f(G,J,X);const Q=K.exports,Y={__name:"slack-preview",props:{ogTitle:String,ogSiteName:String,ogDescription:String,ogImage:String,url:String},setup(s){const e=s,t=d(()=>new window.URL(e.url).origin),r=d(()=>new window.URL(e.url).hostname),i=m(!0);return{__sfc:!0,props:e,origin:t,domain:r,showImage:i}}};var ee=function(){var e=this,t=e._self._c,r=e._self._setupProxy;return t("div",{staticClass:"k-slack-preview"},[t("div",{staticClass:"k-slack-preview__content"},[t("div",{staticClass:"k-slack-preview__site-name"},[t("img",{staticClass:"k-slack-preview__favicon",attrs:{src:`https://www.google.com/s2/favicons?domain=${r.domain}&sz=16`,alt:`${e.ogSiteName} favicon`}}),e._v(" "+e._s(e.ogSiteName||r.origin)+" ")]),t("span",{staticClass:"k-slack-preview__title"},[e._v(e._s(e.ogTitle))]),t("p",{staticClass:"k-slack-preview__description"},[e._v(" "+e._s(e.ogDescription)+" "),e.ogImage?t("button",{staticClass:"k-slack-preview__image-toggle",on:{click:function(i){r.showImage=!r.showImage}}},[e._v(" "+e._s(r.showImage?"▼":"▶")+" ")]):e._e()])]),e.ogImage&&r.showImage?t("div",{staticClass:"k-slack-preview__image"},[t("img",{attrs:{src:e.ogImage}})]):e._e()])},te=[],re=f(Y,ee,te);const se=re.exports,ae={__name:"seo-preview",props:$,setup(s){const e=s,t=h(),r=V(),{load:i}=k(),n=m(null),u=m([]),o=d(()=>e.parent==="site"),l=d(()=>{var p;return e.label||((p=t==null?void 0:t.t)==null?void 0:p.call(t,"seo.sections.preview.title"))||"Preview"}),g=d(()=>{var y;const p=(y=n.value)==null?void 0:y.pageTitle;if(o.value&&p){const ce=p.replaceAll('"','\\"');return`${l.value} (shows "${ce}")`}return l.value}),c=m(window.localStorage.getItem("kSEOPreviewType")??"google");N(c,p=>{window.localStorage.setItem("kSEOPreviewType",p)});const _=()=>{i({parent:e.parent,name:e.name}).then(p=>{n.value=p.meta,u.value=p.options,!window.localStorage.getItem("kSEOPreviewType")&&p.options.length>0&&(c.value=p.options[0].value)})},v=()=>{var p;(p=n.value)!=null&&p.panelUrl&&r.$go(n.value.panelUrl)};return b(()=>{_(),t.events.on("content.save",p=>{_()})}),S(()=>t.events.off("content.save")),{__sfc:!0,props:e,panel:t,app:r,load:i,meta:n,options:u,isSiteParent:o,baseLabel:l,headerLabel:g,type:c,handleLoad:_,openPanelTarget:v,FacebookPreview:W,GooglePreview:Q,SlackPreview:se}}};var ie=function(){var i;var e=this,t=e._self._c,r=e._self._setupProxy;return t("div",{staticClass:"k-section k-seo-preview"},[t("div",{staticClass:"k-field-header k-seo-preview__label k-label k-field-label"},[t("k-icon",{attrs:{type:"preview"}}),t("span",{staticClass:"k-label-text"},[e._v(" "+e._s(r.headerLabel)+" ")]),r.isSiteParent&&((i=r.meta)!=null&&i.panelUrl)?t("k-button",{staticClass:"k-seo-preview__panel-button",attrs:{variant:"filled",size:"xs",icon:"edit"},on:{click:r.openPanelTarget}},[e._v(" View page in panel ")]):e._e()],1),t("k-select-field",{attrs:{type:"select",name:"seo-preview-type",before:e.$t("seo.sections.preview.showFor"),options:r.options,required:!0,empty:!1},model:{value:r.type,callback:function(n){r.type=n},expression:"type"}}),r.meta?t("div",{staticClass:"k-seo-preview__inner"},[r.type==="google"?t(r.GooglePreview,e._b({},"google-preview",r.meta,!1)):e._e(),r.type==="facebook"?t(r.FacebookPreview,e._b({},"facebook-preview",r.meta,!1)):e._e(),r.type==="slack"?t(r.SlackPreview,e._b({},"slack-preview",r.meta,!1)):e._e()],1):e._e()],1)},ne=[],oe=f(ae,ie,ne);const le=oe.exports;panel.plugin("tobimori/seo",{icons:{"seo-ai":'<path d="M16.4356 3.21188C16.8261 2.82185 17.4592 2.82157 17.8496 3.21188L20.6777 6.04099C21.0681 6.43152 21.0682 7.06457 20.6777 7.45505L7.2422 20.8896H3.00001V16.6475L16.4356 3.21188ZM5.00001 17.4756V18.8896H6.41407L15.7276 9.57615L14.3135 8.16208L5.00001 17.4756ZM4.5293 1.3193C4.70583 0.893505 5.29418 0.893508 5.47071 1.3193L5.72364 1.93063C6.15555 2.97342 6.96155 3.80613 7.97462 4.2568L8.69239 4.57614C9.10267 4.75896 9.10262 5.35616 8.69239 5.53903L7.93263 5.87692C6.94497 6.3162 6.15339 7.11943 5.71387 8.1279L5.4668 8.69334C5.28636 9.10747 4.71366 9.10747 4.53321 8.69334L4.28614 8.1279C3.84661 7.11943 3.05506 6.3162 2.06739 5.87692L1.30762 5.53903C0.897483 5.35617 0.897435 4.75896 1.30762 4.57614L2.0254 4.2568C3.03845 3.80614 3.84446 2.97344 4.27637 1.93063L4.5293 1.3193ZM15.7276 6.74802L17.1426 8.16208L18.5567 6.74802L17.1426 5.33395L15.7276 6.74802Z" />',robots:'<path d="M13.5 2c0 .444-.193.843-.5 1.118V5h5a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3h5V3.118A1.5 1.5 0 1 1 13.5 2ZM6 7a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1H6Zm-4 3H0v6h2v-6Zm20 0h2v6h-2v-6ZM9 14.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm6 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />',"robots-off":'<path fill-rule="evenodd" clip-rule="evenodd" d="M21 16.786V8a3 3 0 0 0-3-3h-5V3.118a1.5 1.5 0 1 0-2 0V5H9.214l2 2H18a1 1 0 0 1 1 1v6.786l2 2ZM2.093 3.507l2.099 2.099A2.995 2.995 0 0 0 3 8v10a3 3 0 0 0 3 3h12c.463 0 .902-.105 1.293-.292l1.9 1.9 1.414-1.415-6.88-6.88a1.5 1.5 0 1 0-2.04-2.04L3.508 2.093 2.093 3.507ZM5 8a1 1 0 0 1 .65-.937L17.585 19H6a1 1 0 0 1-1-1V8Zm-5 2h2v6H0v-6Zm24 0h-2v6h2v-6Zm-13.5 3a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />'},sections:{"heading-structure":D,"seo-preview":le},fields:{"seo-writer":L},components:{"k-seo-writer-input":H},writerNodes:{seoTemplateTitle:w({name:"seoTemplateTitle",icon:"page",variable:"title",label:"seo.writerNodes.template.title",theme:"blue"}),seoTemplateSiteTitle:w({name:"seoTemplateSiteTitle",icon:"globe",variable:"site.title",label:"seo.writerNodes.template.siteTitle",theme:"purple"})}})})();
